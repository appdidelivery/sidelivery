<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Admin - SI Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .nav-link-active { background-color: #3b82f6; color: white; }
        .toggle-bg:after { content: ''; position: absolute; top: 2px; left: 2px; background: white; border-radius: 9999px; height: 1.25rem; width: 1.25rem; transition: transform 0.2s ease-in-out; }
        input:checked + .toggle-bg:after { transform: translateX(100%); }
        input:checked + .toggle-bg { background-color: #22c55e; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .receipt-copy { font-family: 'Courier New', Courier, monospace; width: 48%; float: left; margin: 1%; padding: 10px; border: 1px dashed #000; box-sizing: border-box; }
            .receipt-header { text-align: center; border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 5px; }
            .receipt-items th, .receipt-items td { text-align: left; padding: 2px 0; }
            .receipt-items .price { text-align: right; }
            .receipt-footer { border-top: 1px solid #000; padding-top: 5px; margin-top: 5px; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-loader" class="flex flex-col items-center justify-center min-h-screen"><i class="fa-solid fa-spinner fa-spin fa-3x text-blue-500"></i><p class="mt-4 text-lg text-gray-600">A carregar painel...</p></div>
    <div id="login-screen" class="hidden items-center justify-center min-h-screen"><div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg"><h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Painel de Admin</h2><p class="text-center text-gray-500 mb-6">Acesso restrito.</p><form id="login-form"><div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-600 mb-1">Email</label><input type="email" id="email" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></div><div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-600 mb-1">Senha</label><input type="password" id="password" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></div><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">Entrar</button><p id="login-error" class="text-red-500 text-sm text-center mt-4 hidden"></p></form></div></div>

    <div id="admin-panel" class="hidden h-screen bg-gray-100">
        <div class="flex h-full">
            <div class="w-64 bg-gray-800 text-white p-5 flex flex-col">
                <h1 class="text-2xl font-bold mb-10">Admin SI Delivery</h1>
                <nav>
                    <a href="#dashboard" class="nav-link block py-2.5 px-4 rounded nav-link-active"><i class="fa-solid fa-chart-line mr-3"></i>Dashboard</a>
                    <a href="#orders" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700"><i class="fa-solid fa-receipt mr-3"></i>Pedidos</a>
                    <a href="#products" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700"><i class="fa-solid fa-box-archive mr-3"></i>Produtos</a>
                    <a href="#categories" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700"><i class="fa-solid fa-tags mr-3"></i>Categorias</a>
                    <a href="#coupons" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700"><i class="fa-solid fa-ticket mr-3"></i>Cupons</a>
                    <a href="#customers" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700"><i class="fa-solid fa-users mr-3"></i>Clientes</a>
                    <a href="#finance" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700"><i class="fa-solid fa-dollar-sign mr-3"></i>Financeiro</a>
                </nav>
                <div class="mt-auto"><p id="auth-info-admin" class="text-xs text-gray-400">Carregando...</p><button id="logout-btn" class="w-full mt-2 text-left py-2.5 px-4 rounded hover:bg-red-500 transition-colors"><i class="fa-solid fa-right-from-bracket mr-3"></i>Sair</button></div>
            </div>

            <div class="flex-1 flex flex-col overflow-hidden">
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                    <section id="dashboard" class="admin-section"></section>
                    <section id="orders" class="admin-section hidden"></section>
                    <section id="products" class="admin-section hidden"></section>
                    <section id="categories" class="admin-section hidden"></section>
                    <section id="coupons" class="admin-section hidden"></section>
                    <section id="finance" class="admin-section hidden"></section>
                    <section id="customers" class="admin-section hidden"></section>
                </main>
            </div>
        </div>
    </div>

    <div id="print-area" class="hidden"><div id="print-content"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, getDocs, setDoc, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const appLoader = document.getElementById('app-loader');
            const loginScreen = document.getElementById('login-screen');
            const adminPanel = document.getElementById('admin-panel');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');

            const firebaseConfig = {
                apiKey: "AIzaSyD_LdDobMQqltW6ejDwibcyoeUoX_BoHEs",
                authDomain: "zetesteapp.firebaseapp.com",
                projectId: "zetesteapp",
                storageBucket: "zetesteapp.appspot.com",
                messagingSenderId: "344839359009",
                appId: "1:344839359009:web:c5e4af43649c5a39d8f160"
            };
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            const productsCollection = collection(db, "products");
            const ordersCollection = collection(db, "orders");
            const couponsCollection = collection(db, "coupons");
            const usersCollection = collection(db, "users");
            const categoriesCollection = collection(db, "categories");
            
            let ordersCache = [], productsCache = [], customersCache = [];
            let salesChart = null;

            onAuthStateChanged(auth, async (user) => {
                appLoader.classList.add('hidden');
                if (user) {
                    document.getElementById('auth-info-admin').textContent = `Admin Conectado`;
                    adminPanel.classList.remove('hidden');
                    loginScreen.classList.add('hidden');
                    loginScreen.classList.remove('flex');
                    
                    await addSampleDataIfNeeded();
                    
                    initializeListeners();
                } else {
                    adminPanel.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                    loginScreen.classList.add('flex');
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value)
                    .catch(error => {
                        loginError.textContent = "Email ou senha inválidos.";
                        loginError.classList.remove('hidden');
                    });
            });

            logoutBtn.addEventListener('click', () => signOut(auth));

            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.admin-section');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('nav-link-active'));
                    link.classList.add('nav-link-active');
                    
                    const targetId = link.getAttribute('href').substring(1);
                    sections.forEach(section => {
                        section.id === targetId ? section.classList.remove('hidden') : section.classList.add('hidden');
                    });
                });
            });
            
            // --- INICIALIZAÇÃO GERAL ---
            function initializeListeners() {
                listenToAllData();
            }
            
            // --- CARREGAMENTO DE DADOS E RENDERIZAÇÃO ---
            function listenToAllData() {
                onSnapshot(query(ordersCollection), snapshot => {
                    ordersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderDashboard();
                    renderOrders();
                    renderFinance();
                });
                onSnapshot(query(productsCollection), snapshot => {
                    productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderDashboard();
                    renderProducts();
                });
                 onSnapshot(query(usersCollection), snapshot => {
                    customersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderDashboard();
                    renderCustomers();
                });
                // Outros listeners (categorias, cupons) podem ser adicionados aqui se precisarem de atualizações em tempo real no dashboard
                listenToCategories();
                listenToCoupons();
            }

            // --- DASHBOARD ---
            function renderDashboard() {
                const dashboardSection = document.getElementById('dashboard');
                const today = new Date();
                today.setHours(0,0,0,0);

                const todaysOrders = ordersCache.filter(o => o.createdAt && o.createdAt.toDate() >= today);
                const todaysRevenue = todaysOrders.reduce((sum, o) => sum + o.total, 0);
                const ticketMedio = todaysOrders.length > 0 ? todaysRevenue / todaysOrders.length : 0;
                
                const lowStockProducts = productsCache.filter(p => p.stock <= 5);

                dashboardSection.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4">Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-gray-500 text-sm">Faturamento (Hoje)</p><p class="text-2xl font-bold">R$ ${todaysRevenue.toFixed(2)}</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-gray-500 text-sm">Pedidos (Hoje)</p><p class="text-2xl font-bold">${todaysOrders.length}</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-gray-500 text-sm">Ticket Médio (Hoje)</p><p class="text-2xl font-bold">R$ ${ticketMedio.toFixed(2)}</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><p class="text-gray-500 text-sm">Total de Clientes</p><p class="text-2xl font-bold">${customersCache.length}</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="font-bold mb-4">Pedidos Recentes</h3>
                            <div class="space-y-3">${ordersCache.slice(0, 5).map(o => `<div class="text-sm">${o.customerName} - R$ ${o.total.toFixed(2)} <span class="text-xs text-gray-500 float-right">${o.createdAt.toDate().toLocaleTimeString('pt-BR')}</span></div>`).join('') || '<p class="text-sm text-gray-500">Nenhum pedido hoje.</p>'}</div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="font-bold mb-4 text-red-600">Produtos com Stock Baixo</h3>
                            <div class="space-y-3">${lowStockProducts.map(p => `<div class="text-sm">${p.name} <span class="font-bold float-right">${p.stock} un.</span></div>`).join('') || '<p class="text-sm text-gray-500">Nenhum produto com stock baixo.</p>'}</div>
                        </div>
                    </div>
                `;
            }

            // --- SEÇÕES (Pedidos, Produtos, etc.) ---
            function renderOrders() {
                const section = document.getElementById('orders');
                section.innerHTML = `<h2 class="text-2xl font-semibold mb-4">Pedidos Recebidos</h2><div id="orders-list" class="space-y-4">${ordersCache.map(order => '...').join('')}</div>`;
                // A lógica completa de renderização de pedidos, impressão, etc. vai aqui
            }

            function renderProducts() {
                const section = document.getElementById('products');
                // Lógica de renderização dos produtos
            }
            
            function renderCategories() {
                const section = document.getElementById('categories');
                // Lógica de renderização das categorias
            }

            function renderCoupons() {
                const section = document.getElementById('coupons');
                // Lógica de renderização dos cupons
            }

            function renderCustomers() {
                const section = document.getElementById('customers');
                // Lógica de renderização dos clientes
            }
            
            function renderFinance() {
                const section = document.getElementById('finance');
                section.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4">Financeiro e Relatórios</h2>
                    <div class="mb-4"><button class="report-filter-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm" data-period="today">Hoje</button> <button class="report-filter-btn px-3 py-1 rounded-md text-sm" data-period="7days">Últimos 7 Dias</button> <button class="report-filter-btn px-3 py-1 rounded-md text-sm" data-period="month">Este Mês</button></div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="font-bold mb-4">Relatório de Vendas</h3>
                        <div id="report-summary" class="grid grid-cols-3 gap-4 mb-6"></div>
                        <canvas id="salesChart"></canvas>
                    </div>
                `;
                document.querySelectorAll('.report-filter-btn').forEach(btn => btn.addEventListener('click', (e) => generateReport(e.currentTarget.dataset.period)));
                generateReport('today');
            }

            function generateReport(period) {
                let startDate = new Date();
                startDate.setHours(0,0,0,0);

                if (period === '7days') {
                    startDate.setDate(startDate.getDate() - 6);
                } else if (period === 'month') {
                    startDate.setDate(1);
                }

                const filteredOrders = ordersCache.filter(o => o.createdAt && o.createdAt.toDate() >= startDate);
                const totalRevenue = filteredOrders.reduce((sum, o) => sum + o.total, 0);
                const totalOrders = filteredOrders.length;
                
                const productSales = {};
                filteredOrders.forEach(o => o.items.forEach(item => {
                    productSales[item.name] = (productSales[item.name] || 0) + item.quantity;
                }));
                const topProducts = Object.entries(productSales).sort((a,b) => b[1] - a[1]).slice(0,3);

                document.getElementById('report-summary').innerHTML = `
                    <div><p class="text-gray-500 text-sm">Faturamento Total</p><p class="text-xl font-bold">R$ ${totalRevenue.toFixed(2)}</p></div>
                    <div><p class="text-gray-500 text-sm">Total de Pedidos</p><p class="text-xl font-bold">${totalOrders}</p></div>
                    <div><p class="text-gray-500 text-sm">Produtos Mais Vendidos</p><div class="text-xs">${topProducts.map(p => `${p[0]} (${p[1]})`).join('<br>')}</div></div>
                `;

                const salesByDay = {};
                filteredOrders.forEach(o => {
                    const day = o.createdAt.toDate().toLocaleDateString('pt-BR');
                    salesByDay[day] = (salesByDay[day] || 0) + o.total;
                });

                if (salesChart) salesChart.destroy();
                const ctx = document.getElementById('salesChart').getContext('2d');
                salesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(salesByDay),
                        datasets: [{
                            label: 'Faturamento por Dia',
                            data: Object.values(salesByDay),
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: { scales: { y: { beginAtZero: true } } }
                });
            }

            // --- O RESTANTE DAS FUNÇÕES (CRUD, IMPRESSÃO, ETC.) VAI AQUI ---
            // ... (código de listenToOrders, listenToProducts, etc. que já tínhamos)

        });
    </script>
</body>
</html>
