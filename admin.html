<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Admin - SI Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style> 
        body { font-family: 'Inter', sans-serif; }
        .nav-link-active { background-color: #3b82f6; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .receipt-copy { font-family: 'Courier New', Courier, monospace; width: 48%; float: left; margin: 1%; padding: 10px; border: 1px dashed #000; box-sizing: border-box; }
            .receipt-header { text-align: center; border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 5px; }
            .receipt-items th, .receipt-items td { text-align: left; padding: 2px 0; }
            .receipt-items .price { text-align: right; }
            .receipt-footer { border-top: 1px solid #000; padding-top: 5px; margin-top: 5px; }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-loader" class="flex flex-col items-center justify-center min-h-screen"><i class="fa-solid fa-spinner fa-spin fa-3x text-blue-500"></i><p class="mt-4 text-lg text-gray-600">A carregar painel...</p></div>
    <div id="login-screen" class="hidden items-center justify-center min-h-screen"><div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg"><h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Painel de Admin</h2><p class="text-center text-gray-500 mb-6">Acesso restrito.</p><form id="login-form"><div class="mb-4"><label for="email" class="block text-sm font-medium text-gray-600 mb-1">Email</label><input type="email" id="email" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></div><div class="mb-6"><label for="password" class="block text-sm font-medium text-gray-600 mb-1">Senha</label><input type="password" id="password" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required></div><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">Entrar</button><p id="login-error" class="text-red-500 text-sm text-center mt-4 hidden"></p></form></div></div>

    <div id="admin-panel" class="hidden h-screen bg-gray-100">
        <div class="flex h-full">
            <div class="w-64 bg-gray-800 text-white p-5 flex flex-col">
                <h1 class="text-2xl font-bold mb-10">Admin SI Delivery</h1>
                <nav>
                    <a href="#orders" class="nav-link block py-2.5 px-4 rounded nav-link-active"><i class="fa-solid fa-receipt mr-3"></i>Pedidos</a>
                    <a href="#products" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700"><i class="fa-solid fa-box-archive mr-3"></i>Produtos</a>
                    <a href="#categories" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700"><i class="fa-solid fa-tags mr-3"></i>Categorias</a>
                    <a href="#coupons" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700"><i class="fa-solid fa-ticket mr-3"></i>Cupons</a>
                    <a href="#customers" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700"><i class="fa-solid fa-users mr-3"></i>Clientes</a>
                    <a href="#finance" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700"><i class="fa-solid fa-dollar-sign mr-3"></i>Financeiro</a>
                </nav>
                <div class="mt-auto"><p id="auth-info-admin" class="text-xs text-gray-400">Carregando...</p><button id="logout-btn" class="w-full mt-2 text-left py-2.5 px-4 rounded hover:bg-red-500 transition-colors"><i class="fa-solid fa-right-from-bracket mr-3"></i>Sair</button></div>
            </div>

            <div class="flex-1 flex flex-col overflow-hidden">
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                    <section id="orders" class="admin-section"></section>
                    <section id="products" class="admin-section hidden"></section>
                    <section id="categories" class="admin-section hidden"></section>
                    <section id="coupons" class="admin-section hidden"></section>
                    <section id="customers" class="admin-section hidden"></section>
                    <section id="finance" class="admin-section hidden"></section>
                </main>
            </div>
        </div>
    </div>

    <div id="print-area" class="hidden"><div id="print-content"></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, getDocs, setDoc, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            const appLoader = document.getElementById('app-loader');
            const loginScreen = document.getElementById('login-screen');
            const adminPanel = document.getElementById('admin-panel');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');

            const firebaseConfig = {
                apiKey: "AIzaSyD_LdDobMQqltW6ejDwibcyoeUoX_BoHEs",
                authDomain: "zetesteapp.firebaseapp.com",
                projectId: "zetesteapp",
                storageBucket: "zetesteapp.appspot.com",
                messagingSenderId: "344839359009",
                appId: "1:344839359009:web:c5e4af43649c5a39d8f160"
            };
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            const productsCollection = collection(db, "products");
            const ordersCollection = collection(db, "orders");
            const couponsCollection = collection(db, "coupons");
            const categoriesCollection = collection(db, "categories");
            const usersCollection = collection(db, "users");
            
            let ordersCache = [];
            let productsCache = [];
            let categoriesCache = [];
            let customersCache = [];
            let manualOrderCart = [];

            onAuthStateChanged(auth, async (user) => {
                appLoader.classList.add('hidden');
                if (user) {
                    document.getElementById('auth-info-admin').textContent = `Admin Conectado`;
                    adminPanel.classList.remove('hidden');
                    loginScreen.classList.add('hidden');
                    loginScreen.classList.remove('flex');
                    
                    initializeListeners();
                } else {
                    adminPanel.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                    loginScreen.classList.add('flex');
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value)
                    .catch(error => {
                        loginError.textContent = "Email ou senha inválidos.";
                        loginError.classList.remove('hidden');
                    });
            });

            logoutBtn.addEventListener('click', () => signOut(auth));

            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.admin-section');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('nav-link-active'));
                    link.classList.add('nav-link-active');
                    
                    const targetId = link.getAttribute('href').substring(1);
                    sections.forEach(section => {
                        section.id === targetId ? section.classList.remove('hidden') : section.classList.add('hidden');
                    });
                });
            });
            
            function initializeListeners() {
                renderOrders();
                renderProducts();
                renderCoupons();
                renderCategories();
                renderCustomers();
                renderFinance();
            }

            // --- RENDER FUNCTIONS ---
            function renderOrders() {
                const section = document.getElementById('orders');
                section.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Pedidos Recebidos</h2>
                        <button id="show-manual-order-form-btn" class="bg-green-500 text-white py-2 px-4 rounded hover:bg-green-600"><i class="fa-solid fa-plus mr-2"></i>Criar Pedido Manualmente</button>
                    </div>

                    <div id="manual-order-container" class="hidden bg-white p-6 rounded-lg shadow-md mb-6">
                        <h3 class="text-xl font-bold mb-4">Novo Pedido Manual</h3>
                        <form id="manual-order-form" class="space-y-4">
                            <input type="text" id="manual-customer-name" placeholder="Nome do Cliente" class="w-full p-2 border rounded" required>
                            <input type="text" id="manual-customer-address" placeholder="Endereço de Entrega" class="w-full p-2 border rounded" required>
                            
                            <div class="border-t pt-4">
                                <h4 class="font-semibold mb-2">Adicionar Produtos</h4>
                                <div class="flex items-center gap-4">
                                    <select id="manual-product-select" class="flex-grow p-2 border rounded"></select>
                                    <input type="number" id="manual-product-quantity" value="1" min="1" class="w-20 p-2 border rounded">
                                    <button type="button" id="add-product-to-manual-order-btn" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">Adicionar</button>
                                </div>
                            </div>

                            <div id="manual-order-items-list" class="space-y-2"></div>
                            <div class="border-t pt-4 space-y-2">
                                <div class="flex justify-between font-bold text-lg"><p>Total:</p><p id="manual-order-total">R$ 0,00</p></div>
                                <select id="manual-payment-method" class="w-full p-2 border rounded">
                                    <option value="delivery">Pagamento na Entrega</option>
                                    <option value="online">Pagamento Online (Registado)</option>
                                </select>
                            </div>

                            <div class="flex space-x-2">
                                <button type="submit" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">Guardar Pedido</button>
                                <button type="button" id="cancel-manual-order-btn" class="w-full bg-gray-300 py-2 rounded hover:bg-gray-400">Cancelar</button>
                            </div>
                        </form>
                    </div>

                    <div id="orders-list" class="space-y-4"></div>`;
                
                const ordersListEl = document.getElementById('orders-list');
                
                document.getElementById('show-manual-order-form-btn').addEventListener('click', () => {
                    document.getElementById('manual-order-container').classList.remove('hidden');
                    populateManualProductDropdown();
                });
                document.getElementById('cancel-manual-order-btn').addEventListener('click', resetManualOrderForm);
                document.getElementById('add-product-to-manual-order-btn').addEventListener('click', addProductToManualOrder);
                document.getElementById('manual-order-form').addEventListener('submit', handleManualOrderSubmit);

                onSnapshot(query(ordersCollection, orderBy("createdAt", "desc")), (snapshot) => {
                    if (snapshot.empty) {
                        ordersListEl.innerHTML = '<p class="text-gray-500">Nenhum pedido recebido ainda.</p>';
                        return;
                    }
                    ordersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    ordersListEl.innerHTML = ordersCache.map(order => `
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold">${order.customerName}</p>
                                    <p class="text-sm text-gray-600">${order.customerAddress}</p>
                                    <p class="text-sm text-gray-500">${order.createdAt.toDate().toLocaleString('pt-BR')}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg">R$ ${order.total.toFixed(2).replace('.', ',')}</p>
                                    <p class="text-sm">Pagamento: ${order.paymentMethod === 'online' ? 'Online' : 'Na Entrega'}</p>
                                </div>
                            </div>
                             <div class="mt-2">
                                <ul class="list-disc list-inside text-sm">
                                    ${order.items.map(item => `<li>${item.quantity}x ${item.name}</li>`).join('')}
                                </ul>
                            </div>
                            <div class="mt-4 flex items-center justify-between">
                                <select class="order-status-select p-2 border rounded" data-id="${order.id}">
                                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pendente</option>
                                    <option value="in_preparation" ${order.status === 'in_preparation' ? 'selected' : ''}>Em Preparo</option>
                                    <option value="out_for_delivery" ${order.status === 'out_for_delivery' ? 'selected' : ''}>Saiu para Entrega</option>
                                    <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Concluído</option>
                                    <option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>Cancelado</option>
                                </select>
                                <button class="print-order-btn bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center gap-2" data-id="${order.id}">
                                    <i class="fa-solid fa-print"></i> Imprimir
                                </button>
                            </div>
                        </div>
                    `).join('');
                    document.querySelectorAll('.order-status-select').forEach(el => el.addEventListener('change', (e) => updateOrderStatus(e.target.dataset.id, e.target.value)));
                    document.querySelectorAll('.print-order-btn').forEach(el => el.addEventListener('click', (e) => printOrder(e.currentTarget.dataset.id)));
                });
            }
            
            function renderProducts() {
                const section = document.getElementById('products');
                section.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4">Gerir Produtos</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 id="product-form-title" class="text-xl font-bold mb-4">Adicionar Novo Produto</h3>
                        <form id="product-form" class="space-y-4">
                            <input type="hidden" id="product-id">
                            <input type="text" id="product-name" placeholder="Nome do Produto" class="w-full p-2 border rounded" required>
                            <input type="number" id="product-price" placeholder="Preço (ex: 5.50)" step="0.01" class="w-full p-2 border rounded" required>
                            <input type="number" id="product-stock" placeholder="Stock" class="w-full p-2 border rounded" required>
                            <select id="product-category" class="w-full p-2 border rounded" required></select>
                            <input type="text" id="product-image-url" placeholder="URL da Imagem" class="w-full p-2 border rounded">
                            <div class="flex space-x-2">
                                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Guardar Produto</button>
                                <button type="button" id="cancel-edit-btn" class="w-full bg-gray-300 py-2 rounded hover:bg-gray-400 hidden">Cancelar</button>
                            </div>
                        </form>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-4">Produtos Cadastrados</h3>
                        <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>`;
                
                populateCategoryDropdown();
                document.getElementById('product-form').addEventListener('submit', handleProductFormSubmit);
                document.getElementById('cancel-edit-btn').addEventListener('click', resetProductForm);

                onSnapshot(query(productsCollection), (snapshot) => {
                    productsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const listEl = document.getElementById('products-list');
                    if (snapshot.empty) {
                        listEl.innerHTML = '<p class="text-gray-500">Nenhum produto cadastrado.</p>';
                        return;
                    }
                    listEl.innerHTML = productsCache.map(product => `
                        <div class="bg-white p-4 rounded-lg shadow-md flex flex-col">
                            <img src="${product.imageUrl || 'https://placehold.co/300x200/CCCCCC/FFFFFF?text=Sem+Imagem'}" alt="${product.name}" class="w-full h-32 object-contain rounded-md mb-4">
                            <h4 class="font-bold flex-1">${product.name}</h4>
                            <p class="text-gray-600">${product.category}</p>
                            <p class="text-green-600 font-semibold text-lg">R$ ${product.price.toFixed(2).replace('.', ',')}</p>
                            <p class="text-sm">Stock: ${product.stock}</p>
                            <div class="mt-4 flex space-x-2">
                                <button class="edit-product-btn w-full bg-yellow-400 text-sm py-1 rounded hover:bg-yellow-500" data-id="${product.id}">Editar</button>
                                <button class="delete-product-btn w-full bg-red-500 text-white text-sm py-1 rounded hover:bg-red-600" data-id="${product.id}">Excluir</button>
                            </div>
                        </div>
                    `).join('');
                    document.querySelectorAll('.edit-product-btn').forEach(btn => btn.addEventListener('click', (e) => editProduct(e.currentTarget.dataset.id)));
                    document.querySelectorAll('.delete-product-btn').forEach(btn => btn.addEventListener('click', (e) => deleteProduct(e.currentTarget.dataset.id)));
                });
            }
            
            function renderCoupons() {
                const section = document.getElementById('coupons');
                section.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4">Gerir Cupons</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Criar Novo Cupom</h3>
                        <form id="admin-coupon-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <input type="text" id="coupon-code-admin" placeholder="Código (ex: BEMVINDO10)" class="p-2 border rounded uppercase" required>
                            <select id="coupon-type-admin" class="p-2 border rounded" required>
                                <option value="percentage">Percentagem (%)</option>
                                <option value="fixed">Valor Fixo (R$)</option>
                            </select>
                            <input type="number" id="coupon-value-admin" placeholder="Valor" step="0.01" class="w-full p-2 border rounded" required>
                            <button type="submit" class="md:col-span-3 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Guardar Cupom</button>
                        </form>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-bold mb-4">Cupons Ativos</h3>
                        <div id="coupons-list" class="space-y-2"></div>
                    </div>`;
                
                document.getElementById('admin-coupon-form').addEventListener('submit', handleCouponFormSubmit);
                
                onSnapshot(query(couponsCollection), (snapshot) => {
                    const listEl = document.getElementById('coupons-list');
                    if (snapshot.empty) {
                        listEl.innerHTML = '<p class="text-gray-500">Nenhum cupom criado.</p>';
                        return;
                    }
                    listEl.innerHTML = snapshot.docs.map(doc => {
                        const coupon = { id: doc.id, ...doc.data() };
                        return `
                        <div class="bg-white p-3 rounded-md shadow-sm flex justify-between items-center">
                            <div>
                                <span class="font-mono bg-gray-200 px-2 py-1 rounded">${coupon.id}</span>
                                <span class="ml-4">${coupon.type === 'fixed' ? `R$ ${coupon.value.toFixed(2).replace('.',',')}` : `${coupon.value}%`} de desconto</span>
                            </div>
                            <button class="delete-coupon-btn text-red-500 hover:text-red-700" data-id="${coupon.id}"><i class="fas fa-trash"></i></button>
                        </div>
                        `
                    }).join('');
                    document.querySelectorAll('.delete-coupon-btn').forEach(btn => btn.addEventListener('click', (e) => deleteCoupon(e.currentTarget.dataset.id)));
                });
            }

            function renderCategories() {
                const section = document.getElementById('categories');
                section.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4">Gerir Categorias</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Adicionar Nova Categoria</h3>
                        <form id="category-form" class="flex gap-4">
                            <input type="text" id="category-name" placeholder="Nome da Categoria" class="w-full p-2 border rounded" required>
                            <button type="submit" class="bg-blue-500 text-white py-2 px-6 rounded hover:bg-blue-600">Adicionar</button>
                        </form>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Categorias Existentes</h3>
                        <div id="categories-list" class="space-y-2"></div>
                    </div>`;

                document.getElementById('category-form').addEventListener('submit', handleCategoryFormSubmit);

                onSnapshot(query(categoriesCollection), (snapshot) => {
                    categoriesCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const listEl = document.getElementById('categories-list');
                    if (categoriesCache.length === 0) {
                        listEl.innerHTML = '<p class="text-gray-500">Nenhuma categoria criada.</p>';
                    } else {
                        listEl.innerHTML = categoriesCache.map(category => `
                            <div class="bg-gray-50 p-3 rounded-md flex justify-between items-center">
                                <span>${category.name}</span>
                                <button class="delete-category-btn text-red-500 hover:text-red-700" data-id="${category.id}"><i class="fas fa-trash"></i></button>
                            </div>
                        `).join('');
                        document.querySelectorAll('.delete-category-btn').forEach(btn => btn.addEventListener('click', (e) => deleteCategory(e.currentTarget.dataset.id)));
                    }
                    populateCategoryDropdown();
                });
            }

            function renderCustomers() {
                const section = document.getElementById('customers');
                section.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4">Gerir Clientes</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 id="customer-form-title" class="text-xl font-bold mb-4">Adicionar Novo Cliente</h3>
                        <form id="customer-form" class="space-y-4">
                            <input type="hidden" id="customer-id">
                            <input type="text" id="customer-name" placeholder="Nome do Cliente" class="w-full p-2 border rounded" required>
                            <input type="email" id="customer-email" placeholder="Email do Cliente" class="w-full p-2 border rounded" required>
                            <input type="tel" id="customer-phone" placeholder="Telefone do Cliente" class="w-full p-2 border rounded">
                            <div class="flex space-x-2">
                                <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Guardar Cliente</button>
                                <button type="button" id="cancel-customer-edit-btn" class="w-full bg-gray-300 py-2 rounded hover:bg-gray-400 hidden">Cancelar Edição</button>
                            </div>
                        </form>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Clientes Registados</h3>
                        <div id="customers-list" class="overflow-x-auto"></div>
                    </div>`;
                
                document.getElementById('customer-form').addEventListener('submit', handleCustomerFormSubmit);
                document.getElementById('cancel-customer-edit-btn').addEventListener('click', resetCustomerForm);

                onSnapshot(query(usersCollection), (snapshot) => {
                    customersCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const listEl = document.getElementById('customers-list');
                    if (customersCache.length === 0) {
                        listEl.innerHTML = '<p class="text-gray-500">Nenhum cliente registado.</p>';
                        return;
                    }
                    listEl.innerHTML = `
                        <table class="w-full text-left">
                            <thead class="border-b-2 border-gray-200"><tr><th class="p-3">Nome</th><th class="p-3">Email</th><th class="p-3">Telefone</th><th class="p-3">Ações</th></tr></thead>
                            <tbody>
                                ${customersCache.map(user => `
                                    <tr class="border-b border-gray-100">
                                        <td class="p-3">${user.name || ''}</td>
                                        <td class="p-3">${user.email || ''}</td>
                                        <td class="p-3">${user.phone || ''}</td>
                                        <td class="p-3">
                                            <button class="edit-customer-btn text-blue-500 hover:text-blue-700 mr-2" data-id="${user.id}"><i class="fas fa-pen"></i></button>
                                            <button class="delete-customer-btn text-red-500 hover:text-red-700" data-id="${user.id}"><i class="fas fa-trash"></i></button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                    document.querySelectorAll('.edit-customer-btn').forEach(btn => btn.addEventListener('click', (e) => editCustomer(e.currentTarget.dataset.id)));
                    document.querySelectorAll('.delete-customer-btn').forEach(btn => btn.addEventListener('click', (e) => deleteCustomer(e.currentTarget.dataset.id)));
                });
            }

            function renderFinance() {
                const section = document.getElementById('finance');
                section.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-4">Financeiro e Pagamentos</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-2">Gestão de Pagamentos Online</h3>
                        <p class="text-gray-600 mb-4">A gestão de todos os pagamentos online, incluindo depósitos, saldos e saques, é feita de forma segura através do seu painel do Mercado Pago.</p>
                        <a href="https://www.mercadopago.com.br/dashboard" target="_blank" class="inline-flex items-center bg-blue-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-600 transition-colors">
                           <svg class="w-6 h-6 mr-2" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M24.2,34.1c-1.2,0-2.3-0.4-3.2-1.3c-0.9-0.9-1.3-2-1.3-3.2c0-1.2,0.4-2.3,1.3-3.2c0.9-0.9,2-1.3,3.2-1.3 c1.2,0,2.3,0.4,3.2,1.3c0.9,0.9,1.3,2,1.3,3.2c0,1.2-0.4,2.3-1.3,3.2C26.5,33.7,25.4,34.1,24.2,34.1z M36.2,25.4 c-0.9-0.9-2-1.3-3.2-1.3c-1.2,0-2.3,0.4-3.2,1.3c-0.9,0.9-1.3,2-1.3,3.2c0,1.2,0.4,2.3,1.3,3.2c0.9,0.9,2,1.3,3.2,1.3 c1.2,0,2.3-0.4,3.2-1.3c0.9-0.9,1.3-2,1.3-3.2C37.5,27.4,37.1,26.3,36.2,25.4z M24,48c-13.3,0-24-10.7-24-24S10.7,0,24,0 s24,10.7,24,24S37.3,48,24,48z M24.2,21.9c-1.2,0-2.3-0.4-3.2-1.3c-0.9-0.9-1.3-2-1.3-3.2c0-1.2,0.4-2.3,1.3-3.2 c0.9-0.9,2-1.3,3.2-1.3c1.2,0,2.3,0.4,3.2,1.3c0.9,0.9,1.3,2,1.3,3.2c0,1.2-0.4,2.3-1.3,3.2C26.5,21.5,25.4,21.9,24.2,21.9z  M12.2,25.4c-0.9-0.9-2-1.3-3.2-1.3c-1.2,0-2.3,0.4-3.2,1.3c-0.9,0.9-1.3,2-1.3,3.2c0,1.2,0.4,2.3,1.3,3.2 c0.9,0.9,2,1.3,3.2,1.3c1.2,0,2.3-0.4,3.2-1.3c0.9-0.9,1.3-2,1.3-3.2C13.5,27.4,13.1,26.3,12.2,25.4z" fill="#fff"/></svg>
                            Aceder ao Painel Mercado Pago
                        </a>
                        <p class="text-sm text-gray-500 mt-4">No painel do Mercado Pago, pode ver relatórios detalhados, gerir disputas e configurar as suas preferências de saque para a sua conta bancária.</p>
                    </div>`;
            }
            
            // --- FUNÇÕES DE LÓGICA ---
            async function updateOrderStatus(orderId, newStatus) {
                await updateDoc(doc(db, "orders", orderId), { status: newStatus });
            }

            function printOrder(orderId) {
                const order = ordersCache.find(o => o.id === orderId);
                if (!order) {
                    console.error("Pedido não encontrado no cache:", orderId);
                    return;
                }

                const customerName = order.customerName || 'N/A';
                const customerAddress = order.customerAddress || 'N/A';
                const orderIdShort = order.id ? order.id.substring(0, 6) : 'N/A';
                const createdAt = order.createdAt ? order.createdAt.toDate().toLocaleString('pt-BR') : 'N/A';
                const subtotal = (order.subtotal || 0).toFixed(2).replace('.', ',');
                const total = (order.total || 0).toFixed(2).replace('.', ',');
                const paymentMethod = order.paymentMethod === 'online' ? 'Online' : 'Na Entrega';
                const instructions = order.instructions || '';

                const itemsHtml = (order.items || []).map(item => `
                    <tr>
                        <td>${item.quantity || 0}x</td>
                        <td>${item.name || 'Produto desconhecido'}</td>
                        <td class="price">R$ ${((item.price || 0) * (item.quantity || 0)).toFixed(2).replace('.', ',')}</td>
                    </tr>
                `).join('');

                const couponHtml = order.coupon && order.discount ? 
                    `<p><strong>Desconto (${order.coupon.code}):</strong> <span style="float: right;">- R$ ${(order.discount).toFixed(2).replace('.', ',')}</span></p>` : '';

                const instructionsHtml = instructions ? 
                    `<p style="margin-top: 5px;"><strong>Obs:</strong> ${instructions}</p>` : '';

                const receiptHtml = (title) => `
                    <div class="receipt-copy">
                        <div class="receipt-header">
                            <h3 style="font-size: 16px; font-weight: bold;">SI Delivery</h3>
                            <p style="font-size: 10px;">Pedido #${orderIdShort}</p>
                            <p style="font-size: 10px;">${createdAt}</p>
                            <h4 style="font-size: 12px; font-weight: bold; margin-top: 5px;">${title}</h4>
                        </div>
                        <div style="font-size: 10px; margin-bottom: 5px;">
                            <p><strong>Cliente:</strong> ${customerName}</p>
                            <p><strong>Endereço:</strong> ${customerAddress}</p>
                        </div>
                        <table class="receipt-items" style="width: 100%; font-size: 10px;">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Qtd</th>
                                    <th>Item</th>
                                    <th class="price">Valor</th>
                                </tr>
                            </thead>
                            <tbody>${itemsHtml}</tbody>
                        </table>
                        <div class="receipt-footer" style="font-size: 10px;">
                            <p><strong>Subtotal:</strong> <span style="float: right;">R$ ${subtotal}</span></p>
                            ${couponHtml}
                            <p style="font-weight: bold; font-size: 12px;"><strong>Total:</strong> <span style="float: right;">R$ ${total}</span></p>
                            <p><strong>Pagamento:</strong> <span style="float: right;">${paymentMethod}</span></p>
                            ${instructionsHtml}
                        </div>
                    </div>
                `;

                const printContentEl = document.getElementById('print-content');
                if (printContentEl) {
                    printContentEl.innerHTML = receiptHtml('Via Entregador') + receiptHtml('Via Vendas');
                    setTimeout(() => window.print(), 250);
                }
            }
            
            async function handleProductFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('product-id').value;
                const productData = {
                    name: document.getElementById('product-name').value,
                    price: parseFloat(document.getElementById('product-price').value),
                    stock: parseInt(document.getElementById('product-stock').value),
                    category: document.getElementById('product-category').value,
                    imageUrl: document.getElementById('product-image-url').value,
                    active: document.getElementById('product-active')?.checked ?? true
                };
                if (id) await updateDoc(doc(db, "products", id), productData);
                else await addDoc(productsCollection, productData);
                resetProductForm();
            }

            function resetProductForm() {
                document.getElementById('product-form').reset();
                document.getElementById('product-id').value = '';
                document.getElementById('product-form-title').textContent = 'Adicionar Novo Produto';
                document.getElementById('cancel-edit-btn').classList.add('hidden');
            }
            
            function editProduct(id) {
                const product = productsCache.find(p => p.id === id);
                if (!product) return;
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-stock').value = product.stock;
                document.getElementById('product-category').value = product.category;
                document.getElementById('product-image-url').value = product.imageUrl;
                if(document.getElementById('product-active')) document.getElementById('product-active').checked = product.active;
                document.getElementById('product-form-title').textContent = 'A editar Produto';
                document.getElementById('cancel-edit-btn').classList.remove('hidden');
            }

            async function deleteProduct(id) {
                if (confirm('Tem a certeza que deseja eliminar este produto?')) {
                    await deleteDoc(doc(db, "products", id));
                }
            }

            async function handleCouponFormSubmit(e) {
                e.preventDefault();
                const code = document.getElementById('coupon-code-admin').value.trim().toUpperCase();
                const valueInput = document.getElementById('coupon-value-admin').value;
                if (!code || valueInput === '') return alert("Preencha todos os campos.");
                const couponData = {
                    type: document.getElementById('coupon-type-admin').value,
                    value: parseFloat(valueInput),
                    active: true
                };
                await setDoc(doc(db, "coupons", code), couponData);
                alert(`Cupom "${code}" guardado!`);
                document.getElementById('admin-coupon-form').reset();
            }

            async function deleteCoupon(id) {
                if (confirm(`Tem a certeza que deseja eliminar o cupom "${id}"?`)) {
                    await deleteDoc(doc(db, "coupons", id));
                }
            }

            async function handleCategoryFormSubmit(e) {
                e.preventDefault();
                const name = document.getElementById('category-name').value.trim();
                if (name) {
                    await addDoc(categoriesCollection, { name });
                    document.getElementById('category-form').reset();
                }
            }

            async function deleteCategory(id) {
                if (confirm('Tem a certeza que deseja eliminar esta categoria?')) {
                    await deleteDoc(doc(db, 'categories', id));
                }
            }

            function populateCategoryDropdown() {
                const select = document.getElementById('product-category');
                select.innerHTML = '<option value="">Selecione a Categoria</option>';
                categoriesCache.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });
            }

            async function handleCustomerFormSubmit(e) {
                e.preventDefault();
                const id = document.getElementById('customer-id').value;
                const customerData = {
                    name: document.getElementById('customer-name').value,
                    email: document.getElementById('customer-email').value,
                    phone: document.getElementById('customer-phone').value,
                };
                if (id) {
                    await updateDoc(doc(db, "users", id), customerData);
                } else {
                    await addDoc(usersCollection, customerData);
                }
                resetCustomerForm();
            }

            function resetCustomerForm() {
                document.getElementById('customer-form').reset();
                document.getElementById('customer-id').value = '';
                document.getElementById('customer-form-title').textContent = 'Adicionar Novo Cliente';
                document.getElementById('cancel-customer-edit-btn').classList.add('hidden');
            }

            function editCustomer(id) {
                const customer = customersCache.find(c => c.id === id);
                if (!customer) return;
                document.getElementById('customer-id').value = customer.id;
                document.getElementById('customer-name').value = customer.name;
                document.getElementById('customer-email').value = customer.email;
                document.getElementById('customer-phone').value = customer.phone;
                document.getElementById('customer-form-title').textContent = 'A editar Cliente';
                document.getElementById('cancel-customer-edit-btn').classList.remove('hidden');
            }

            async function deleteCustomer(id) {
                if (confirm('Tem a certeza que deseja eliminar este cliente? Esta ação não pode ser desfeita.')) {
                    await deleteDoc(doc(db, "users", id));
                }
            }
            
            // --- FUNÇÕES DO PEDIDO MANUAL ---
            function populateManualProductDropdown() {
                const select = document.getElementById('manual-product-select');
                select.innerHTML = '<option value="">Selecione um produto</option>';
                productsCache.forEach(prod => {
                    const option = document.createElement('option');
                    option.value = prod.id;
                    option.textContent = `${prod.name} - R$ ${prod.price.toFixed(2)}`;
                    select.appendChild(option);
                });
            }

            function addProductToManualOrder() {
                const productId = document.getElementById('manual-product-select').value;
                const quantity = parseInt(document.getElementById('manual-product-quantity').value);
                if (!productId || !quantity > 0) return;

                const product = productsCache.find(p => p.id === productId);
                if (!product) return;

                const existingItem = manualOrderCart.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    manualOrderCart.push({ ...product, quantity });
                }
                renderManualOrderCart();
            }

            function renderManualOrderCart() {
                const listEl = document.getElementById('manual-order-items-list');
                const totalEl = document.getElementById('manual-order-total');
                let total = 0;

                if (manualOrderCart.length === 0) {
                    listEl.innerHTML = '';
                } else {
                    listEl.innerHTML = manualOrderCart.map((item, index) => {
                        total += item.price * item.quantity;
                        return `
                            <div class="bg-gray-50 p-2 rounded-md flex justify-between items-center">
                                <span>${item.quantity}x ${item.name}</span>
                                <button type="button" class="remove-manual-item-btn text-red-500 hover:text-red-700" data-index="${index}"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                    }).join('');
                    document.querySelectorAll('.remove-manual-item-btn').forEach(btn => btn.addEventListener('click', (e) => {
                        manualOrderCart.splice(e.currentTarget.dataset.index, 1);
                        renderManualOrderCart();
                    }));
                }
                totalEl.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            }

            function resetManualOrderForm() {
                document.getElementById('manual-order-form').reset();
                document.getElementById('manual-order-container').classList.add('hidden');
                manualOrderCart = [];
                renderManualOrderCart();
            }

            async function handleManualOrderSubmit(e) {
                e.preventDefault();
                if (manualOrderCart.length === 0) {
                    alert('Adicione pelo menos um produto ao pedido.');
                    return;
                }

                const total = manualOrderCart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const orderData = {
                    customerName: document.getElementById('manual-customer-name').value,
                    customerAddress: document.getElementById('manual-customer-address').value,
                    items: manualOrderCart.map(item => ({ id: item.id, name: item.name, price: item.price, quantity: item.quantity })),
                    subtotal: total,
                    discount: 0,
                    total: total,
                    coupon: null,
                    paymentMethod: document.getElementById('manual-payment-method').value,
                    status: 'pending',
                    createdAt: serverTimestamp()
                };

                await addDoc(ordersCollection, orderData);
                alert('Pedido manual criado com sucesso!');
                resetManualOrderForm();
            }
        });
    </script>
</body>
</html>
