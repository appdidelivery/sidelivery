<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Admin - SI Delivery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style> 
        body { 
            font-family: 'Inter', sans-serif; 
        }
        /* Estilos para a impressão */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .receipt-copy {
                font-family: 'Courier New', Courier, monospace;
                width: 48%; /* Duas colunas */
                float: left;
                margin: 1%;
                padding: 10px;
                border: 1px dashed #000;
            }
            .receipt-header {
                text-align: center;
                border-bottom: 1px solid #000;
                padding-bottom: 5px;
                margin-bottom: 5px;
            }
            .receipt-items th, .receipt-items td {
                text-align: left;
                padding: 2px 0;
            }
            .receipt-items .price {
                text-align: right;
            }
            .receipt-footer {
                border-top: 1px solid #000;
                padding-top: 5px;
                margin-top: 5px;
            }
        }
    </style>
</head>
<body class="bg-gray-200">

    <div id="app-loader" class="flex flex-col items-center justify-center min-h-screen bg-gray-100">
        <i class="fa-solid fa-spinner fa-spin fa-3x text-blue-500"></i>
        <p class="mt-4 text-lg text-gray-600">A carregar painel...</p>
    </div>

    <div id="login-screen" class="hidden items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-sm p-8 bg-white rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-2">Painel de Admin</h2>
            <p class="text-center text-gray-500 mb-6">Acesso restrito.</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-gray-600 mb-1">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-600 mb-1">Senha</label>
                    <input type="password" id="password" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">Entrar</button>
                <p id="login-error" class="text-red-500 text-sm text-center mt-4 hidden"></p>
            </form>
        </div>
    </div>


    <div id="admin-panel" class="hidden h-screen bg-gray-200">
        <div class="flex h-full">
            
            <div class="w-64 bg-gray-800 text-white p-5 flex flex-col">
                <h1 class="text-2xl font-bold mb-10">Admin SI Delivery</h1>
                <nav>
                    <a href="#orders" class="nav-link block py-2.5 px-4 rounded bg-gray-700">Pedidos</a>
                    <a href="#products" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700">Produtos</a>
                    <a href="#coupons" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700">Cupons</a>
                    <a href="#finance" class="nav-link block py-2.5 px-4 rounded hover:bg-gray-700">Financeiro</a>
                </nav>
                <div class="mt-auto">
                    <p id="auth-info-admin" class="text-xs text-gray-400">Carregando...</p>
                    <button id="logout-btn" class="w-full mt-2 text-left py-2.5 px-4 rounded hover:bg-red-500 transition-colors">Sair</button>
                </div>
            </div>

            <div class="flex-1 flex flex-col overflow-hidden">
                <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                    
                    <section id="orders" class="admin-section">
                        <h2 class="text-2xl font-semibold mb-4">Pedidos Recebidos</h2>
                        <div id="orders-list" class="space-y-4">
                            <p class="text-gray-500">A carregar pedidos...</p>
                        </div>
                    </section>

                    <section id="products" class="admin-section hidden">
                        <h2 class="text-2xl font-semibold mb-4">Gerir Produtos</h2>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 id="form-title" class="text-xl font-bold mb-4">Adicionar Novo Produto</h3>
                            <form id="product-form" class="space-y-4">
                                <input type="hidden" id="product-id">
                                <input type="text" id="product-name" placeholder="Nome do Produto" class="w-full p-2 border rounded" required>
                                <input type="number" id="product-price" placeholder="Preço (ex: 5.50)" step="0.01" class="w-full p-2 border rounded" required>
                                <select id="product-category" class="w-full p-2 border rounded" required>
                                    <option value="">Selecione a Categoria</option>
                                    <option value="Cervejas">Cervejas</option>
                                    <option value="Destilados">Destilados</option>
                                    <option value="Vinhos">Vinhos</option>
                                    <option value="Sem Álcool">Sem Álcool</option>
                                    <option value="Para Acompanhar">Para Acompanhar</option>
                                </select>
                                <input type="text" id="product-image-url" placeholder="URL da Imagem" class="w-full p-2 border rounded">
                                <div class="flex space-x-2">
                                    <button type="submit" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Guardar Produto</button>
                                    <button type="button" id="cancel-edit-btn" class="w-full bg-gray-300 py-2 rounded hover:bg-gray-400 hidden">Cancelar Edição</button>
                                </div>
                            </form>
                        </div>

                        <div class="mt-8">
                            <h3 class="text-xl font-bold mb-4">Produtos Cadastrados</h3>
                            <div id="products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <p class="text-gray-500">A carregar produtos...</p>
                            </div>
                        </div>
                    </section>

                    <section id="coupons" class="admin-section hidden">
                        <h2 class="text-2xl font-semibold mb-4">Gerir Cupons</h2>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 id="coupon-form-title" class="text-xl font-bold mb-4">Criar Novo Cupom</h3>
                            <form id="admin-coupon-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                                <input type="text" id="coupon-code-admin" placeholder="Código (ex: BEMVINDO10)" class="p-2 border rounded uppercase" required>
                                <select id="coupon-type-admin" class="p-2 border rounded" required>
                                    <option value="percentage">Percentagem (%)</option>
                                    <option value="fixed">Valor Fixo (R$)</option>
                                </select>
                                <input type="number" id="coupon-value-admin" placeholder="Valor" step="0.01" class="w-full p-2 border rounded" required>
                                <button type="submit" class="md:col-span-3 w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">Guardar Cupom</button>
                            </form>
                        </div>
                        <div class="mt-8">
                            <h3 class="text-xl font-bold mb-4">Cupons Ativos</h3>
                            <div id="coupons-list" class="space-y-2">
                                 <p class="text-gray-500">A carregar cupons...</p>
                            </div>
                        </div>
                    </section>
                    
                    <section id="finance" class="admin-section hidden">
                        <h2 class="text-2xl font-semibold mb-4">Financeiro e Pagamentos</h2>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-bold mb-2">Gestão de Pagamentos Online</h3>
                            <p class="text-gray-600 mb-4">A gestão de todos os pagamentos online, incluindo depósitos, saldos e saques, é feita de forma segura através do seu painel da Stripe.</p>
                            <a href="https://dashboard.stripe.com" target="_blank" class="inline-block bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-indigo-700 transition-colors">
                                <i class="fa-brands fa-stripe-s mr-2"></i> Aceder ao Painel Stripe
                            </a>
                            <p class="text-sm text-gray-500 mt-4">No painel da Stripe, pode ver relatórios detalhados, gerir disputas e configurar as suas preferências de saque para a sua conta bancária.</p>
                        </div>
                    </section>

                </main>
            </div>
        </div>
    </div>

    <div id="print-area" class="hidden">
        <div id="print-content"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, query, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DO DOM ---
            const appLoader = document.getElementById('app-loader');
            const loginScreen = document.getElementById('login-screen');
            const adminPanel = document.getElementById('admin-panel');
            const loginForm = document.getElementById('login-form');
            const loginError = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');

            // --- CONFIGURAÇÃO DO FIREBASE ---
            const firebaseConfig = {
                apiKey: "AIzaSyD_LdDobMQqltW6ejDwibcyoeUoX_BoHEs",
                authDomain: "zetesteapp.firebaseapp.com",
                projectId: "zetesteapp",
                storageBucket: "zetesteapp.firebasestorage.app",
                messagingSenderId: "344839359009",
                appId: "1:344839359009:web:c5e4af43649c5a39d8f160"
            };
            
            // --- INICIALIZAÇÃO DO FIREBASE ---
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            const productsCollection = collection(db, "products");
            const ordersCollection = collection(db, "orders");
            const couponsCollection = collection(db, "coupons");
            let ordersCache = [];

            // --- AUTENTICAÇÃO ---
            onAuthStateChanged(auth, async (user) => {
                appLoader.classList.add('hidden');
                if (user) {
                    document.getElementById('auth-info-admin').textContent = `Admin Conectado`;
                    adminPanel.classList.remove('hidden');
                    loginScreen.classList.add('hidden');
                    loginScreen.classList.remove('flex');
                    
                    await addSampleDataIfNeeded();
                    
                    listenToOrders();
                    listenToProducts();
                    listenToCoupons();
                } else {
                    adminPanel.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                    loginScreen.classList.add('flex');
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value)
                    .catch(error => {
                        loginError.textContent = "Email ou senha inválidos.";
                        loginError.classList.remove('hidden');
                    });
            });

            logoutBtn.addEventListener('click', () => signOut(auth));

            // --- NAVEGAÇÃO ---
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.admin-section');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('bg-gray-700'));
                    link.classList.add('bg-gray-700');
                    
                    const targetId = link.getAttribute('href').substring(1);
                    sections.forEach(section => {
                        section.id === targetId ? section.classList.remove('hidden') : section.classList.add('hidden');
                    });
                });
            });

            // --- ADICIONAR DADOS DE EXEMPLO ---
            async function addSampleDataIfNeeded() {
                const q = query(productsCollection);
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    console.log("Base de dados de produtos vazia. A adicionar produtos de exemplo...");
                    const sampleProducts = [
                        { name: 'Cerveja Brahma Duplo Malte 350ml', price: 3.79, category: 'Cervejas', imageUrl: 'https://acdn.mitiendanube.com/stores/001/335/204/products/brahma-duplo-malte-lata-350ml1-c30f8c83d63006093416239565725803-1024-1024.png' },
                        { name: 'Cerveja Skol Pilsen 350ml', price: 3.29, category: 'Cervejas', imageUrl: 'https://cdn.dooca.store/145/products/cerveja-skol-pilsen-lata-350ml_640x640+fill_ffffff.png?v=1608313937&webp=0' },
                        { name: 'Cerveja Heineken Lager 330ml', price: 5.49, category: 'Cervejas', imageUrl: 'https://www.imigrantesbebidas.com.br/bebida/images/products/full/1922-cerveja-heineken-long-neck-330ml.png' },
                        { name: 'Gin Tanqueray London Dry 750ml', price: 109.90, category: 'Destilados', imageUrl: 'https://www.paodeacucar.com/img/uploads/1/914/20237914.png' },
                        { name: 'Vodka Absolut Original 750ml', price: 89.90, category: 'Destilados', imageUrl: 'https://www.bancadoramon.com.br/media/catalog/product/cache/1/image/1000x/9df78eab33525d08d6e5fb8d27136e95/v/o/vodka_absolut.png' },
                        { name: 'Whisky Johnnie Walker Red Label 750ml', price: 85.00, category: 'Destilados', imageUrl: 'https://www.casadabebida.com.br/media/catalog/product/cache/1/image/900x900/9df78eab33525d08d6e5fb8d27136e95/w/h/whisky-johnnie-walker-red-label-750-ml.png' },
                        { name: 'Vinho Chileno Casillero del Diablo 750ml', price: 55.00, category: 'Vinhos', imageUrl: 'https://http2.mlstatic.com/D_NQ_NP_912201-MLB20299902841_052015-O.png' },
                        { name: 'Coca-Cola Sem Açúcar 2L', price: 9.50, category: 'Sem Álcool', imageUrl: 'https://images.tcdn.com.br/img/img_prod/839446/refrigerante_coca_cola_sem_acucar_2l_533_1_20201021134707.png' },
                        { name: 'Guaraná Antarctica 2L', price: 8.50, category: 'Sem Álcool', imageUrl: 'https://www.paodeacucar.com/img/uploads/1/432/521432.png' },
                        { name: 'Gelo em Cubo 5kg', price: 10.00, category: 'Para Acompanhar', imageUrl: 'https://static.distribuidoracaue.com.br/media/catalog/product/cache/1/image/900x900/9df78eab33525d08d6e5fb8d27136e95/g/e/gelo-em-cubo-filtrado-pacote-5-kg-gelo-sete.png' },
                        { name: 'Carvão Vegetal 3kg', price: 15.00, category: 'Para Acompanhar', imageUrl: 'https://http2.mlstatic.com/D_NQ_NP_983193-MLB45738411209_042021-O.png' },
                    ];
                    for (const product of sampleProducts) {
                        await addDoc(productsCollection, product);
                    }
                }
            }

            // --- GERENCIAMENTO DE PEDIDOS ---
            function listenToOrders() {
                const q = query(ordersCollection);
                onSnapshot(q, (snapshot) => {
                    const ordersList = document.getElementById('orders-list');
                    if (snapshot.empty) {
                        ordersList.innerHTML = '<p class="text-gray-500">Nenhum pedido recebido ainda.</p>';
                        return;
                    }
                    ordersCache = [];
                    snapshot.forEach(doc => ordersCache.push({ id: doc.id, ...doc.data() }));
                    ordersCache.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

                    ordersList.innerHTML = ordersCache.map(order => {
                        let paymentDetails = `<p class="text-sm">Pagamento: ${order.paymentMethod === 'online' ? 'Online (Stripe)' : 'Na Entrega'}</p>`;
                        if (order.paymentMethod === 'online' && order.stripePaymentId) {
                            paymentDetails += `<p class="text-xs text-gray-500 truncate" title="${order.stripePaymentId}">ID: ${order.stripePaymentId}</p>`;
                        }

                        return `
                        <div class="bg-white p-4 rounded-lg shadow-md">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold">${order.customerName}</p>
                                    <p class="text-sm text-gray-600">${order.customerAddress}</p>
                                    <p class="text-sm text-gray-500">${order.createdAt.toDate().toLocaleString('pt-BR')}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg">R$ ${order.total.toFixed(2).replace('.', ',')}</p>
                                    ${paymentDetails}
                                </div>
                            </div>
                             <div class="mt-2">
                                <ul class="list-disc list-inside text-sm">
                                    ${order.items.map(item => `<li>${item.quantity}x ${item.name}</li>`).join('')}
                                </ul>
                            </div>
                            ${order.instructions ? `<div class="mt-2 p-2 bg-yellow-100 rounded-md text-sm"><strong>Instruções:</strong> ${order.instructions}</div>` : ''}
                            ${order.coupon ? `<div class="mt-2 text-sm text-green-600"><strong>Cupom Usado:</strong> ${order.coupon.code} (-R$ ${order.coupon.discount.toFixed(2).replace('.',',')})</div>` : ''}
                            <div class="mt-4 flex items-center justify-between">
                                <select onchange="updateOrderStatus('${order.id}', this.value)" class="p-2 border rounded">
                                    <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pendente</option>
                                    <option value="in_preparation" ${order.status === 'in_preparation' ? 'selected' : ''}>Em Preparo</option>
                                    <option value="out_for_delivery" ${order.status === 'out_for_delivery' ? 'selected' : ''}>Saiu para Entrega</option>
                                    <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Concluído</option>
                                    <option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>Cancelado</option>
                                </select>
                                <button onclick="printOrder('${order.id}')" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center gap-2">
                                    <i class="fa-solid fa-print"></i> Imprimir
                                </button>
                            </div>
                        </div>
                    `}).join('');
                });
            }

            window.updateOrderStatus = async (orderId, newStatus) => {
                await updateDoc(doc(db, "orders", orderId), { status: newStatus });
            };
            
            // --- FUNÇÃO DE IMPRESSÃO ---
            window.printOrder = (orderId) => {
                const order = ordersCache.find(o => o.id === orderId);
                if (!order) return;

                const itemsHtml = order.items.map(item => `
                    <tr>
                        <td>${item.quantity}x</td>
                        <td>${item.name}</td>
                        <td class="price">R$ ${(item.price * item.quantity).toFixed(2)}</td>
                    </tr>
                `).join('');

                const receiptHtml = (title) => `
                    <div class="receipt-copy">
                        <div class="receipt-header">
                            <h3 style="font-size: 16px; font-weight: bold;">SI Delivery</h3>
                            <p style="font-size: 10px;">Pedido #${order.id.substring(0, 6)}</p>
                            <p style="font-size: 10px;">${order.createdAt.toDate().toLocaleString('pt-BR')}</p>
                            <h4 style="font-size: 12px; font-weight: bold; margin-top: 5px;">${title}</h4>
                        </div>
                        <div style="font-size: 10px; margin-bottom: 5px;">
                            <p><strong>Cliente:</strong> ${order.customerName}</p>
                            <p><strong>Endereço:</strong> ${order.customerAddress}</p>
                        </div>
                        <table class="receipt-items" style="width: 100%; font-size: 10px;">
                            <thead>
                                <tr>
                                    <th style="width: 15%;">Qtd</th>
                                    <th>Item</th>
                                    <th class="price">Valor</th>
                                </tr>
                            </thead>
                            <tbody>${itemsHtml}</tbody>
                        </table>
                        <div class="receipt-footer" style="font-size: 10px;">
                            <p><strong>Subtotal:</strong> <span style="float: right;">R$ ${order.subtotal.toFixed(2)}</span></p>
                            ${order.coupon ? `<p><strong>Desconto (${order.coupon.code}):</strong> <span style="float: right;">- R$ ${order.discount.toFixed(2)}</span></p>` : ''}
                            <p style="font-weight: bold; font-size: 12px;"><strong>Total:</strong> <span style="float: right;">R$ ${order.total.toFixed(2)}</span></p>
                            <p><strong>Pagamento:</strong> <span style="float: right;">${order.paymentMethod === 'online' ? 'Online' : 'Na Entrega'}</span></p>
                            ${order.instructions ? `<p style="margin-top: 5px;"><strong>Obs:</strong> ${order.instructions}</p>` : ''}
                        </div>
                    </div>
                `;

                document.getElementById('print-content').innerHTML = receiptHtml('Via Entregador') + receiptHtml('Via Comercial');
                window.print();
            };

            // --- GERENCIAMENTO DE PRODUTOS (CRUD) ---
            const productForm = document.getElementById('product-form');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');

            productForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('product-id').value;
                const productData = {
                    name: document.getElementById('product-name').value,
                    price: parseFloat(document.getElementById('product-price').value),
                    category: document.getElementById('product-category').value,
                    imageUrl: document.getElementById('product-image-url').value,
                };

                if (id) {
                    await updateDoc(doc(db, "products", id), productData);
                } else {
                    await addDoc(productsCollection, productData);
                }
                resetForm();
            });

            cancelEditBtn.addEventListener('click', resetForm);

            function resetForm() {
                productForm.reset();
                document.getElementById('product-id').value = '';
                document.getElementById('form-title').textContent = 'Adicionar Novo Produto';
                cancelEditBtn.classList.add('hidden');
            }

            function listenToProducts() {
                onSnapshot(productsCollection, (snapshot) => {
                    const productsList = document.getElementById('products-list');
                    if (snapshot.empty) {
                        productsList.innerHTML = '<p class="text-gray-500">Nenhum produto cadastrado.</p>';
                        return;
                    }
                    productsList.innerHTML = '';
                    snapshot.forEach(doc => {
                        const product = { id: doc.id, ...doc.data() };
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow-md flex flex-col';
                        card.innerHTML = `
                            <img src="${product.imageUrl || 'https://placehold.co/300x200/CCCCCC/FFFFFF?text=Sem+Imagem'}" alt="${product.name}" class="w-full h-32 object-contain rounded-md mb-4">
                            <h4 class="font-bold flex-1">${product.name}</h4>
                            <p class="text-gray-600">${product.category}</p>
                            <p class="text-green-600 font-semibold text-lg">R$ ${product.price.toFixed(2).replace('.', ',')}</p>
                            <div class="mt-4 flex space-x-2">
                                <button class="edit-btn w-full bg-yellow-400 text-sm py-1 rounded hover:bg-yellow-500">Editar</button>
                                <button class="delete-btn w-full bg-red-500 text-white text-sm py-1 rounded hover:bg-red-600">Excluir</button>
                            </div>
                        `;
                        card.querySelector('.edit-btn').addEventListener('click', () => editProduct(product));
                        card.querySelector('.delete-btn').addEventListener('click', () => deleteProduct(product.id, product.name));
                        productsList.appendChild(card);
                    });
                });
            }

            function editProduct(product) {
                document.getElementById('product-id').value = product.id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-category').value = product.category;
                document.getElementById('product-image-url').value = product.imageUrl;
                document.getElementById('form-title').textContent = 'A editar Produto';
                cancelEditBtn.classList.remove('hidden');
                window.scrollTo({ top: document.getElementById('products').offsetTop, behavior: 'smooth' });
            }

            async function deleteProduct(id, name) {
                if (confirm(`Tem a certeza que deseja eliminar o produto "${name}"?`)) {
                    await deleteDoc(doc(db, "products", id));
                }
            }

            // --- GERENCIAMENTO DE CUPONS ---
            document.getElementById('admin-coupon-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const code = document.getElementById('coupon-code-admin').value.trim().toUpperCase();
                const couponData = {
                    type: document.getElementById('coupon-type-admin').value,
                    value: parseFloat(document.getElementById('coupon-value-admin').value),
                    active: true
                };
                if (!code || !couponData.value) return;
                
                await setDoc(doc(db, "coupons", code), couponData);
                document.getElementById('admin-coupon-form').reset();
            });

            function listenToCoupons() {
                onSnapshot(query(couponsCollection), (snapshot) => {
                    const listEl = document.getElementById('coupons-list');
                    if (snapshot.empty) {
                        listEl.innerHTML = '<p class="text-gray-500">Nenhum cupom criado.</p>';
                        return;
                    }
                    listEl.innerHTML = '';
                    snapshot.forEach(doc => {
                        const coupon = { id: doc.id, ...doc.data() };
                        const couponCard = document.createElement('div');
                        couponCard.className = 'bg-white p-3 rounded-md shadow-sm flex justify-between items-center';
                        couponCard.innerHTML = `
                            <div>
                                <span class="font-mono bg-gray-200 px-2 py-1 rounded">${coupon.id}</span>
                                <span class="ml-4">${coupon.type === 'fixed' ? `R$ ${coupon.value.toFixed(2).replace('.',',')}` : `${coupon.value}%`} de desconto</span>
                            </div>
                            <button class="delete-coupon-btn text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                        `;
                        couponCard.querySelector('.delete-coupon-btn').addEventListener('click', () => deleteCoupon(coupon.id));
                        listEl.appendChild(couponCard);
                    });
                });
            }

            async function deleteCoupon(id) {
                if (confirm(`Tem a certeza que deseja eliminar o cupom "${id}"?`)) {
                    await deleteDoc(doc(db, "coupons", id));
                }
            }
        });
    </script>
</body>
</html>
