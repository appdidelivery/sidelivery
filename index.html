<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SI Delivery - Conveniência Santa Isabel</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; padding-bottom: 80px; } /* Espaço para o menu inferior */
        .hidden { display: none; }
        .category-btn-active { background-color: #3b82f6; color: white; }
        .category-btn { background-color: #e5e7eb; color: #4b5563; }
        html.dark .category-btn { background-color: #374151; color: #d1d5db; }
        html.dark .category-btn-active { background-color: #3b82f6; color: white; }
        .product-card { cursor: pointer; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); transition: all 0.3s ease; }
        .nav-btn-active { color: #3b82f6; }
        html.dark .nav-btn-active { color: #60a5fa; }
        #product-modal { backdrop-filter: blur(5px); }
    </style>
    <script>
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="app-loader" class="flex flex-col items-center justify-center min-h-screen">
        <i class="fa-solid fa-spinner fa-spin fa-3x text-blue-500"></i>
        <p class="mt-4 text-lg text-gray-600 dark:text-gray-400">A carregar loja...</p>
    </div>

    <div id="app-content" class="hidden">
        <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <svg class="h-10 w-10 text-blue-600 dark:text-blue-500" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9.17117 14.8288L14.8288 9.17117C15.5794 8.42059 16.513 7.53015 16.9322 7.0678C18.6836 5.14984 21.3435 3.32171 21.948 3.05201C22.5525 2.78231 23.218 3.44754 22.948 4.05201C22.6783 4.65648 20.8502 7.31641 18.9322 9.0678L18.4699 9.48697C17.4698 10.487 16.5126 11.4979 15.1712 12.8288L12.8288 15.1712C11.4979 16.5126 10.487 17.4698 9.48697 18.4699L9.0678 18.9322C7.31641 20.8502 4.65648 22.6783 4.05201 22.948C3.44754 23.218 2.78231 22.5525 3.05201 21.948C3.32171 21.3435 5.14984 18.6836 7.0678 16.9322C7.53015 16.513 8.42059 15.5794 9.17117 14.8288Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 12L2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                    <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">SI Delivery</h1>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i id="theme-icon" class="fa-solid fa-moon text-xl"></i></button>
            </div>
        </header>

        <main class="container mx-auto">
            <!-- Tela de Início -->
            <div id="home-view" class="view p-6">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        
                        <!-- Camadas de Promoção -->
                        <div class="space-y-3 mb-8">
                            <div class="bg-green-100 dark:bg-green-900/50 border-l-4 border-green-500 text-green-800 dark:text-green-200 p-4 rounded-lg flex items-center shadow-sm">
                                <i class="fa-solid fa-tags fa-lg mr-4"></i>
                                <div>
                                    <p class="font-bold">10% OFF na sua primeira compra</p>
                                    <p class="text-sm">Use o cupom: <span class="font-mono bg-green-200 dark:bg-green-800/60 px-1 rounded">BEMVINDO10</span></p>
                                </div>
                            </div>
                            <div class="bg-blue-100 dark:bg-blue-900/50 border-l-4 border-blue-500 text-blue-800 dark:text-blue-200 p-4 rounded-lg flex items-center shadow-sm">
                                <i class="fa-solid fa-truck-fast fa-lg mr-4"></i>
                                <div>
                                    <p class="font-bold">Frete Grátis</p>
                                    <p class="text-sm">Em pedidos acima de R$ 50,00</p>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                    <i class="fa-solid fa-search text-gray-400"></i>
                                </span>
                                <input type="text" id="search-bar" placeholder="Procurar por um produto..." class="w-full p-3 pl-10 border dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>

                        <h2 class="text-2xl font-bold mb-4">Nosso Cardápio</h2>
                        <div id="categories-nav" class="flex flex-wrap gap-2 mb-6"></div>
                        <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                        <div id="upsell-section" class="mt-12"><h2 class="text-2xl font-bold mb-4">Para Acompanhar</h2><div id="upsell-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6"></div></div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md sticky top-24">
                            <h2 class="text-2xl font-bold mb-4">O seu Pedido</h2>
                            <div id="cart-items" class="space-y-4 mb-4 max-h-60 overflow-y-auto"><p class="text-gray-500 dark:text-gray-400">O seu carrinho está vazio.</p></div>
                            <div class="border-t dark:border-gray-700 pt-4"><div class="flex justify-between items-center text-gray-600 dark:text-gray-300"><span>Subtotal</span><span id="cart-subtotal">R$ 0,00</span></div><div class="flex justify-between items-center text-sm text-green-600"><span>Desconto</span><span id="cart-discount">- R$ 0,00</span></div><div class="flex justify-between items-center font-bold text-lg mt-2"><span>Total</span><span id="cart-total">R$ 0,00</span></div></div>
                            <div class="mt-4"><form id="coupon-form" class="flex gap-2"><input type="text" id="coupon-code" placeholder="Código do Cupom" class="w-full p-2 border dark:border-gray-600 rounded uppercase bg-gray-100 dark:bg-gray-700"><button type="submit" class="bg-gray-800 dark:bg-gray-600 text-white px-4 rounded hover:bg-gray-900 dark:hover:bg-gray-500">Aplicar</button></form><p id="coupon-message" class="text-sm mt-2"></p></div>
                            <hr class="my-6 dark:border-gray-700">
                            <div><h3 class="text-lg font-bold mb-4">Informações para Entrega</h3><form id="checkout-form" class="space-y-4"><input type="text" id="customer-name" placeholder="O seu Nome" class="w-full p-2 border dark:border-gray-600 rounded bg-gray-100 dark:bg-gray-700" required><input type="text" id="customer-address" placeholder="Endereço de Entrega" class="w-full p-2 border dark:border-gray-600 rounded bg-gray-100 dark:bg-gray-700" required><textarea id="order-instructions" placeholder="Instruções (ex: troco para 50)" class="w-full p-2 border dark:border-gray-600 rounded h-20 bg-gray-100 dark:bg-gray-700"></textarea><h3 class="text-lg font-bold pt-4">Forma de Pagamento</h3><div class="flex gap-4"><button type="button" data-payment="delivery" class="payment-btn flex-1 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600">Pagar na Entrega</button><button type="button" data-payment="online" class="payment-btn flex-1 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600">Pagar Online</button></div></form></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tela Peça de Novo -->
            <div id="reorder-view" class="view hidden p-6">
                <h2 class="text-2xl font-bold mb-4">Peça de Novo</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Clique nos itens dos seus pedidos antigos para adicionar ao carrinho atual.</p>
                <div id="reorder-items-list" class="space-y-4"></div>
            </div>

            <!-- Tela Meus Pedidos -->
            <div id="my-orders-view" class="view hidden p-6">
                <h2 class="text-2xl font-bold mb-4">Meus Pedidos</h2>
                <div id="my-orders-list" class="space-y-4"></div>
            </div>
            
            <!-- Tela de Ajuda -->
            <div id="support-view" class="view hidden p-6">
                <h2 class="text-2xl font-bold mb-4">Central de Ajuda</h2>
                <div class="space-y-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg mb-2">Perguntas Frequentes</h3>
                        <div class="space-y-2 text-sm">
                            <p><strong>P: Qual o tempo de entrega?</strong><br>R: O nosso tempo médio de entrega é de 30-45 minutos.</p>
                            <p><strong>P: Quais as formas de pagamento?</strong><br>R: Aceitamos pagamento na entrega (dinheiro, cartão) e pagamento online (cartão de crédito).</p>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg mb-2">Fale Conosco</h3>
                        <p class="text-sm">Se precisar de ajuda com um pedido, entre em contato:</p>
                        <p class="text-sm mt-2"><i class="fa-solid fa-phone mr-2"></i> (XX) XXXX-XXXX</p>
                        <p class="text-sm"><i class="fa-solid fa-envelope mr-2"></i> suporte@sidelivery.com</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Menu de Navegação Inferior -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-800 shadow-lg border-t dark:border-gray-700 flex justify-around">
            <button class="nav-btn nav-btn-active flex-1 flex flex-col items-center justify-center p-3 text-gray-500 dark:text-gray-400" data-view="home-view">
                <i class="fa-solid fa-house text-xl"></i><span class="text-xs font-medium">Início</span>
            </button>
            <button class="nav-btn flex-1 flex flex-col items-center justify-center p-3 text-gray-500 dark:text-gray-400" data-view="reorder-view">
                <i class="fa-solid fa-repeat text-xl"></i><span class="text-xs font-medium">Peça de Novo</span>
            </button>
            <button class="nav-btn flex-1 flex flex-col items-center justify-center p-3 text-gray-500 dark:text-gray-400" data-view="my-orders-view">
                <i class="fa-solid fa-receipt text-xl"></i><span class="text-xs font-medium">Meus Pedidos</span>
            </button>
            <button class="nav-btn flex-1 flex flex-col items-center justify-center p-3 text-gray-500 dark:text-gray-400" data-view="support-view">
                <i class="fa-solid fa-life-ring text-xl"></i><span class="text-xs font-medium">Ajuda</span>
            </button>
        </nav>
    </div>
    
    <!-- Modal de Sucesso -->
    <div id="success-modal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-50"><div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-sm m-4 text-center p-8"><div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4"><i class="fa-solid fa-check fa-2x text-green-600"></i></div><h3 class="text-xl font-bold mb-2">Pedido Recebido!</h3><p class="text-gray-600 dark:text-gray-300 mb-6">O seu pedido foi enviado com sucesso.</p><button id="close-success-btn" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">Fechar</button></div></div>

    <!-- Modal de Detalhes do Produto -->
    <div id="product-modal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-60">
        <div id="product-modal-content" class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md m-4 relative max-h-[90vh] overflow-y-auto">
            {/* O conteúdo será injetado aqui */}
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DO DOM ---
            const appLoader = document.getElementById('app-loader');
            const appContent = document.getElementById('app-content');
            const productsGrid = document.getElementById('products-grid');
            const upsellGrid = document.getElementById('upsell-grid');
            const categoriesNav = document.getElementById('categories-nav');
            const cartItemsEl = document.getElementById('cart-items');
            const cartSubtotalEl = document.getElementById('cart-subtotal');
            const cartDiscountEl = document.getElementById('cart-discount');
            const cartTotalEl = document.getElementById('cart-total');
            const couponForm = document.getElementById('coupon-form');
            const couponMessageEl = document.getElementById('coupon-message');
            const checkoutForm = document.getElementById('checkout-form');
            const successModal = document.getElementById('success-modal');
            const closeSuccessBtn = document.getElementById('close-success-btn');
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const navButtons = document.querySelectorAll('.nav-btn');
            const views = document.querySelectorAll('.view');
            const reorderItemsList = document.getElementById('reorder-items-list');
            const myOrdersList = document.getElementById('my-orders-list');
            const searchBar = document.getElementById('search-bar');
            const productModal = document.getElementById('product-modal');
            const productModalContent = document.getElementById('product-modal-content');

            // --- CONFIGURAÇÃO DO FIREBASE ---
            const firebaseConfig = {
                apiKey: "AIzaSyAk3MgbFZJjoK3JPU6t0yWILa0DzynaKzY",
                authDomain: "sidelivery-19c9f.firebaseapp.com",
                projectId: "sidelivery-19c9f",
                storageBucket: "sidelivery-19c9f.appspot.com",
                messagingSenderId: "824305265358",
                appId: "1:824305265358:web:912c24aae00034fd003e9f",
                measurementId: "G-GF93Z3H2CT"
            };

            // --- ESTADO DA APLICAÇÃO ---
            let allProducts = [];
            let cart = [];
            let appliedCoupon = null;
            let orderListeners = []; 
            let currentSearchTerm = '';
            let currentCategory = 'Todos';
            
            // --- CHAVE DE TESTE PUBLICÁVEL DO STRIPE ---
            // Substitua por sua chave real em produção
            const stripe = Stripe('pk_test_51PbiUjRsyVfMFqsx1B3j3iU5BqBqWwJv8t2a6Oa3eY7g5eX6d7c8f9g0h1i2j3k4l5m6n7o8p9q0r');


            // --- INICIALIZAÇÃO ---
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);

                // --- LÓGICA DO TEMA ---
                const updateThemeIcon = () => {
                    if (document.documentElement.classList.contains('dark')) {
                        themeIcon.classList.remove('fa-moon');
                        themeIcon.classList.add('fa-sun');
                    } else {
                        themeIcon.classList.remove('fa-sun');
                        themeIcon.classList.add('fa-moon');
                    }
                };
                themeToggle.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                    updateThemeIcon();
                });
                updateThemeIcon();

                // --- FUNÇÕES DE RENDERIZAÇÃO ---
                const createProductCard = (product) => `
                    <div class="product-card bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden flex flex-col" data-id="${product.id}">
                        <div class="flex-grow p-4">
                            <img src="${product.imageUrl || 'https://placehold.co/300x200/e2e8f0/e2e8f0?text=Bebida'}" alt="${product.name}" class="w-full h-40 object-contain">
                            <h3 class="text-md font-bold mt-4 h-12">${product.name}</h3>
                        </div>
                        <div class="p-4 flex justify-between items-center">
                            <p class="text-lg font-extrabold text-blue-600 dark:text-blue-400">R$ ${product.price.toFixed(2).replace('.', ',')}</p>
                            <button class="add-to-cart-btn bg-blue-600 text-white rounded-full h-10 w-10 flex items-center justify-center hover:bg-blue-700 z-10" data-id="${product.id}">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `;

                const renderProducts = () => {
                    let productsToDisplay = allProducts;

                    if (currentCategory !== 'Todos') {
                        productsToDisplay = productsToDisplay.filter(p => p.category === currentCategory);
                    }

                    if (currentSearchTerm) {
                        productsToDisplay = productsToDisplay.filter(p => 
                            p.name.toLowerCase().includes(currentSearchTerm.toLowerCase())
                        );
                    }
                    
                    const mainProducts = productsToDisplay.filter(p => p.category !== 'Para Acompanhar');
                    const upsellProducts = allProducts.filter(p => p.category === 'Para Acompanhar'); // Upsell não é filtrado

                    productsGrid.innerHTML = mainProducts.length > 0 ? mainProducts.map(createProductCard).join('') : `<p class="col-span-full text-center text-gray-500 dark:text-gray-400">Nenhum produto encontrado.</p>`;
                    upsellGrid.innerHTML = upsellProducts.length > 0 ? upsellProducts.map(createProductCard).join('') : '';
                    document.getElementById('upsell-section').style.display = upsellProducts.length > 0 ? 'block' : 'none';

                    attachProductListeners();
                };

                const renderCategories = () => {
                    const mainCategories = allProducts
                        .filter(p => p.category !== 'Para Acompanhar')
                        .map(p => p.category);
                    const categories = ['Todos', ...new Set(mainCategories)];
                    
                    categoriesNav.innerHTML = categories.map(cat => `
                        <button class="category-btn text-sm font-semibold px-4 py-2 rounded-full" data-category="${cat}">${cat}</button>
                    `).join('');
                    
                    const firstButton = categoriesNav.querySelector('button');
                    if (firstButton) firstButton.classList.add('category-btn-active');
                    
                    attachCategoryListeners();
                };

                const renderCart = () => {
                    if (cart.length === 0) {
                        cartItemsEl.innerHTML = `<p class="text-gray-500 dark:text-gray-400">O seu carrinho está vazio.</p>`;
                    } else {
                        cartItemsEl.innerHTML = cart.map(item => `
                            <div class="flex items-center justify-between" data-id="${item.id}">
                                <div>
                                    <p class="font-semibold">${item.name}</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-300">R$ ${item.price.toFixed(2).replace('.', ',')}</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <button class="cart-quantity-btn text-lg hover:text-blue-500" data-action="decrease">-</button>
                                    <span>${item.quantity}</span>
                                    <button class="cart-quantity-btn text-lg hover:text-blue-500" data-action="increase">+</button>
                                </div>
                            </div>
                        `).join('');
                    }
                    
                    const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                    let discount = 0;
                    if (appliedCoupon) {
                        if (appliedCoupon.type === 'fixed') {
                            discount = appliedCoupon.value;
                        } else if (appliedCoupon.type === 'percentage') {
                            discount = (subtotal * appliedCoupon.value) / 100;
                        }
                    }
                    const total = Math.max(0, subtotal - discount);

                    cartSubtotalEl.textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
                    cartDiscountEl.textContent = `- R$ ${discount.toFixed(2).replace('.', ',')}`;
                    cartTotalEl.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
                    
                    attachCartListeners();
                };

                const createOrder = async (paymentInfo = {}) => {
                    if (cart.length === 0) return;

                    const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                    let discount = 0;
                    if (appliedCoupon) {
                       if (appliedCoupon.type === 'fixed') discount = appliedCoupon.value;
                       else if (appliedCoupon.type === 'percentage') discount = (subtotal * appliedCoupon.value) / 100;
                    }
                    const total = Math.max(0, subtotal - discount);

                    const orderData = {
                        customerName: document.getElementById('customer-name').value,
                        customerAddress: document.getElementById('customer-address').value,
                        instructions: document.getElementById('order-instructions').value,
                        items: cart.map(item => ({ id: item.id, name: item.name, price: item.price, quantity: item.quantity })),
                        subtotal,
                        discount,
                        total,
                        coupon: appliedCoupon ? { code: appliedCoupon.id, discount: discount } : null,
                        paymentMethod: paymentInfo.method || 'delivery',
                        stripePaymentId: paymentInfo.id || null,
                        status: 'pending',
                        createdAt: serverTimestamp()
                    };

                    try {
                        const docRef = await addDoc(collection(db, "orders"), orderData);
                        saveOrderToHistory(docRef.id);
                        
                        checkoutForm.reset();
                        couponForm.reset();
                        cart = [];
                        appliedCoupon = null;
                        couponMessageEl.textContent = '';
                        renderCart();
                        successModal.classList.remove('hidden');
                        successModal.classList.add('flex');
                    } catch (error) {
                        console.error("Erro ao criar pedido: ", error);
                        alert("Ocorreu um erro ao enviar o seu pedido.");
                    }
                };

                const handleStripeCheckout = async () => {
                    if (cart.length === 0) {
                        alert("O seu carrinho está vazio.");
                        return;
                    }
                    if (!checkoutForm.checkValidity()) {
                        checkoutForm.reportValidity();
                        alert("Por favor, preencha o seu nome e endereço para continuar.");
                        return;
                    }

                    const payOnlineBtn = document.querySelector('button[data-payment="online"]');
                    const originalBtnText = payOnlineBtn.innerHTML;
                    payOnlineBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> A processar...`;
                    payOnlineBtn.disabled = true;

                    const checkoutData = {
                        customerName: document.getElementById('customer-name').value,
                        customerAddress: document.getElementById('customer-address').value,
                        instructions: document.getElementById('order-instructions').value,
                        cart: cart,
                        appliedCoupon: appliedCoupon
                    };
                    localStorage.setItem('checkoutData', JSON.stringify(checkoutData));

                    const line_items = cart.map(item => ({
                        price_data: {
                            currency: 'brl',
                            product_data: {
                                name: item.name,
                            },
                            unit_amount: Math.round(item.price * 100),
                        },
                        quantity: item.quantity,
                    }));

                    try {
                        const { error } = await stripe.redirectToCheckout({
                            lineItems: line_items,
                            mode: 'payment',
                            successUrl: `${window.location.origin}${window.location.pathname}?stripe_session_id={CHECKOUT_SESSION_ID}`,
                            cancelUrl: `${window.location.origin}${window.location.pathname}`,
                            locale: 'pt-BR'
                        });

                        if (error) {
                            console.error('Erro do Stripe:', error);
                            alert(error.message);
                            payOnlineBtn.innerHTML = originalBtnText;
                            payOnlineBtn.disabled = false;
                        }
                    } catch (e) {
                        console.error('Erro inesperado no checkout:', e);
                        alert('Ocorreu um erro inesperado. Tente novamente.');
                        payOnlineBtn.innerHTML = originalBtnText;
                        payOnlineBtn.disabled = false;
                    }
                };
                
                const checkForStripeSuccess = async () => {
                    const urlParams = new URLSearchParams(window.location.search);
                    const sessionId = urlParams.get('stripe_session_id');

                    if (sessionId) {
                        const checkoutData = JSON.parse(localStorage.getItem('checkoutData'));
                        if (checkoutData) {
                            cart = checkoutData.cart;
                            appliedCoupon = checkoutData.appliedCoupon;
                            document.getElementById('customer-name').value = checkoutData.customerName;
                            document.getElementById('customer-address').value = checkoutData.customerAddress;
                            document.getElementById('order-instructions').value = checkoutData.instructions;
                            
                            await createOrder({ method: 'online', id: sessionId });

                            localStorage.removeItem('checkoutData');
                            window.history.replaceState({}, document.title, window.location.pathname);
                        }
                    }
                };


                // --- LÓGICA DO CARRINHO, CUPONS, PESQUISA E MODAL ---
                const addToCart = (productId) => {
                    const product = allProducts.find(p => p.id === productId);
                    if (!product) return;
                    const cartItem = cart.find(item => item.id === productId);
                    if (cartItem) {
                        cartItem.quantity++;
                    } else {
                        cart.push({ ...product, quantity: 1 });
                    }
                    renderCart();
                };
                
                const updateCartQuantity = (productId, action) => {
                    const cartItem = cart.find(item => item.id === productId);
                    if (!cartItem) return;
                    if (action === 'increase') {
                        cartItem.quantity++;
                    } else if (action === 'decrease') {
                        cartItem.quantity--;
                        if (cartItem.quantity === 0) {
                            cart = cart.filter(item => item.id !== productId);
                        }
                    }
                    renderCart();
                };

                const openProductModal = (productId) => {
                    const product = allProducts.find(p => p.id === productId);
                    if (!product) return;

                    productModalContent.innerHTML = `
                        <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 dark:hover:text-gray-200">
                            <i class="fa-solid fa-times fa-lg"></i>
                        </button>
                        <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-64 object-contain p-4 bg-gray-100 dark:bg-gray-700 rounded-t-lg">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold">${product.name}</h3>
                            <p class="text-gray-700 dark:text-gray-300 mb-6">${product.description || 'Descrição do produto não disponível.'}</p>

                            <div class="flex justify-between items-center">
                                <p class="text-3xl font-extrabold text-blue-600 dark:text-blue-400">R$ ${product.price.toFixed(2).replace('.', ',')}</p>
                                <button class="add-to-cart-btn-modal bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700" data-id="${product.id}">
                                    Adicionar
                                </button>
                            </div>
                        </div>
                    `;
                    productModal.classList.remove('hidden');
                    productModal.classList.add('flex');
                    document.getElementById('close-modal-btn').addEventListener('click', closeProductModal);
                    document.querySelector('.add-to-cart-btn-modal').addEventListener('click', (e) => {
                        addToCart(e.currentTarget.dataset.id);
                        closeProductModal();
                    });
                };

                const closeProductModal = () => {
                    productModal.classList.add('hidden');
                    productModal.classList.remove('flex');
                };
                
                couponForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const code = document.getElementById('coupon-code').value.trim().toUpperCase();
                    if (!code) return;

                    const couponRef = doc(db, "coupons", code);
                    const couponSnap = await getDoc(couponRef);

                    if (couponSnap.exists() && couponSnap.data().active) {
                        appliedCoupon = { id: couponSnap.id, ...couponSnap.data() };
                        couponMessageEl.textContent = `Cupom "${code}" aplicado com sucesso!`;
                        couponMessageEl.className = 'text-sm mt-2 text-green-600';
                    } else {
                        appliedCoupon = null;
                        couponMessageEl.textContent = 'Cupom inválido ou expirado.';
                        couponMessageEl.className = 'text-sm mt-2 text-red-600';
                    }
                    renderCart();
                });

                searchBar.addEventListener('input', (e) => {
                    currentSearchTerm = e.target.value;
                    renderProducts();
                });

                productModal.addEventListener('click', (e) => {
                    if (e.target === productModal) {
                        closeProductModal();
                    }
                });

                // --- LÓGICA DAS NOVAS GUIAS ---
                const getOrderHistory = () => JSON.parse(localStorage.getItem('si_delivery_orders')) || [];
                const saveOrderToHistory = (orderId) => {
                    const history = getOrderHistory();
                    if (!history.includes(orderId)) {
                        history.push(orderId);
                        localStorage.setItem('si_delivery_orders', JSON.stringify(history));
                    }
                };

                const renderReorderItems = async () => {
                    const orderIds = getOrderHistory();
                    if (orderIds.length === 0) {
                        reorderItemsList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Ainda não há pedidos no seu histórico.</p>';
                        return;
                    }

                    reorderItemsList.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-blue-500"></i>';
                    const uniqueItems = {};
                    for (const orderId of orderIds.reverse()) { 
                        const orderSnap = await getDoc(doc(db, "orders", orderId));
                        if (orderSnap.exists()) {
                            orderSnap.data().items.forEach(item => {
                                if (!uniqueItems[item.id]) {
                                    uniqueItems[item.id] = item;
                                }
                            });
                        }
                    }
                    
                    const itemsArray = Object.values(uniqueItems);
                    if (itemsArray.length === 0) {
                         reorderItemsList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Não foi possível carregar os itens dos seus pedidos anteriores.</p>';
                         return;
                    }

                    reorderItemsList.innerHTML = itemsArray.map(item => `
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md flex items-center justify-between">
                            <div>
                                <p class="font-semibold">${item.name}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-300">R$ ${item.price.toFixed(2).replace('.', ',')}</p>
                            </div>
                            <button class="reorder-add-btn bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-400 font-semibold px-4 py-2 rounded-lg hover:bg-blue-200 dark:hover:bg-blue-800" data-id="${item.id}">Adicionar</button>
                        </div>
                    `).join('');
                    
                    document.querySelectorAll('.reorder-add-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            addToCart(btn.dataset.id);
                            btn.textContent = 'Adicionado!';
                            btn.classList.add('bg-green-200');
                            setTimeout(() => {
                                btn.textContent = 'Adicionar';
                                btn.classList.remove('bg-green-200');
                            }, 1000);
                        });
                    });
                };

                const renderMyOrders = () => {
                    orderListeners.forEach(unsubscribe => unsubscribe());
                    orderListeners = [];

                    const orderIds = getOrderHistory();
                    if (orderIds.length === 0) {
                        myOrdersList.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Ainda não há pedidos no seu histórico.</p>';
                        return;
                    }

                    myOrdersList.innerHTML = '';
                    orderIds.reverse().forEach(orderId => {
                        const orderCard = document.createElement('div');
                        orderCard.id = `order-${orderId}`;
                        orderCard.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md';
                        orderCard.innerHTML = '<p>A carregar pedido...</p>';
                        myOrdersList.appendChild(orderCard);

                        const unsubscribe = onSnapshot(doc(db, "orders", orderId), (docSnap) => {
                            if (docSnap.exists()) {
                                const order = docSnap.data();
                                const statusMap = {
                                    pending: { text: 'Pendente', color: 'bg-yellow-500' },
                                    in_preparation: { text: 'Em Preparo', color: 'bg-blue-500' },
                                    out_for_delivery: { text: 'Saiu para Entrega', color: 'bg-purple-500' },
                                    completed: { text: 'Concluído', color: 'bg-green-500' },
                                    canceled: { text: 'Cancelado', color: 'bg-red-500' },
                                };
                                const currentStatus = statusMap[order.status] || { text: order.status, color: 'bg-gray-500' };

                                orderCard.innerHTML = `
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-bold">Pedido #${docSnap.id.substring(0, 6)}</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">${new Date(order.createdAt.seconds * 1000).toLocaleString('pt-BR')}</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-bold text-lg">R$ ${order.total.toFixed(2).replace('.', ',')}</p>
                                            <span class="text-xs font-bold text-white px-2 py-1 rounded-full ${currentStatus.color}">${currentStatus.text}</span>
                                        </div>
                                    </div>
                                    <div class="mt-2 border-t dark:border-gray-700 pt-2">
                                        <ul class="text-sm">
                                            ${order.items.map(item => `<li>${item.quantity}x ${item.name}</li>`).join('')}
                                        </ul>
                                    </div>
                                `;
                            } else {
                                orderCard.innerHTML = `<p class="text-red-500">Pedido #${orderId.substring(0,6)} não encontrado.</p>`;
                            }
                        });
                        orderListeners.push(unsubscribe);
                    });
                };


                // --- LISTENERS GLOBAIS ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        checkForStripeSuccess();
                        onSnapshot(collection(db, "products"), (snapshot) => {
                            allProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            renderCategories();
                            renderProducts();
                            appLoader.classList.add('hidden');
                            appContent.classList.remove('hidden');
                        }, (error) => {
                            appLoader.innerHTML = `<p class="text-red-500">Não foi possível carregar os produtos.</p>`;
                        });
                    }
                });

                signInAnonymously(auth).catch((error) => {
                    appLoader.innerHTML = `<p class="text-red-500">Erro ao conectar com o servidor.</p>`;
                });

                function attachProductListeners() {
                    document.querySelectorAll('.product-card').forEach(card => {
                        card.addEventListener('click', (e) => {
                            if (e.target.closest('.add-to-cart-btn')) {
                                addToCart(e.target.closest('.add-to-cart-btn').dataset.id);
                                return;
                            }
                            openProductModal(card.dataset.id);
                        });
                    });
                }
                
                function attachCategoryListeners() {
                    document.querySelectorAll('.category-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('category-btn-active'));
                            btn.classList.add('category-btn-active');
                            currentCategory = btn.dataset.category;
                            renderProducts();
                        });
                    });
                }

                function attachCartListeners() {
                    document.querySelectorAll('.cart-quantity-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const productId = btn.closest('[data-id]').dataset.id;
                            updateCartQuantity(productId, btn.dataset.action);
                        });
                    });
                }
                
                document.querySelectorAll('.payment-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const paymentMethod = e.target.dataset.payment;
                        if (paymentMethod === 'online') {
                            handleStripeCheckout();
                        } else {
                            if (cart.length === 0 || !checkoutForm.checkValidity()) {
                                checkoutForm.reportValidity();
                                return;
                            }
                            createOrder();
                        }
                    });
                });
                
                closeSuccessBtn.addEventListener('click', () => {
                    successModal.classList.add('hidden');
                    successModal.classList.remove('flex');
                });

                // Navegação principal
                navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetViewId = button.dataset.view;
                        
                        views.forEach(view => {
                            view.id === targetViewId ? view.classList.remove('hidden') : view.classList.add('hidden');
                        });

                        navButtons.forEach(btn => btn.classList.remove('nav-btn-active'));
                        button.classList.add('nav-btn-active');

                        if (targetViewId === 'reorder-view') renderReorderItems();
                        if (targetViewId === 'my-orders-view') renderMyOrders();
                    });
                });

            } catch (e) {
                console.error("Erro fatal na inicialização:", e);
                appLoader.innerHTML = `<p class="text-red-500">Erro crítico na configuração da aplicação.</p>`;
            }
        });
    </script>

</body>
</ht
